<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathMaster Workbook</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { margin-bottom: 1.5rem; }
        .timer { font-size: 1.1rem; font-weight: 500; }
        .correct { background-color: #d4edda !important; }
        .incorrect { background-color: #f8d7da !important; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-light">
<div class="container py-4 d-flex flex-column align-items-center justify-content-center" style="min-height: 100vh;">
    <h1 class="mb-2 text-center">MathMaster Workbook</h1>
    <div class="mb-4 d-flex justify-content-center align-items-center" id="quiz-status-header">
        <span class="badge bg-secondary me-2">Unattempted: <span id="unattempted-count"></span></span>
        <span class="badge bg-success me-2">Answered: <span id="answered-count"></span></span>
        <span class="badge bg-warning text-dark me-2">To Review: <span id="toreview-count"></span></span>
        <span class="badge bg-primary">Total: <span id="total-count"></span></span>
    </div>
    <div id="quiz-area" class="w-100" style="max-width: 900px;">
        <form id="quiz-form">
            <div id="question-list">
                {% for q in questions %}
                <div class="card question-card mx-auto" data-qid="{{q.id}}" style="min-height: 350px; font-size: 1.25rem; {% if not loop.first %}display:none;{% endif %}">
                    <div class="card-body d-flex flex-row">
                        <div class="flex-grow-1 pe-4 border-end">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-primary">Question {{loop.index}} of {{questions|length}}</span>
                                <span class="timer" id="timer-{{q.id}}">Time: 0s</span>
                            </div>
                            <h5 class="card-title" style="font-size:1.5rem;">{{q.question_text}}</h5>
                            <div class="mb-3 mt-4">
                                {% if q.type == 'single' %}
                                    <input type="number" step="any" class="form-control answer-input" name="answer-{{q.id}}" autocomplete="off" style="font-size:1.25rem; height:3rem;">
                                {% elif q.type == 'dual' %}
                                    <div class="row g-2">
                                        <div class="col">
                                            <input type="number" class="form-control answer-input" name="answer-{{q.id}}-quotient" placeholder="Quotient" autocomplete="off" style="font-size:1.25rem; height:3rem;">
                                        </div>
                                        <div class="col">
                                            <input type="number" class="form-control answer-input" name="answer-{{q.id}}-remainder" placeholder="Remainder" autocomplete="off" style="font-size:1.25rem; height:3rem;">
                                        </div>
                                    </div>
                                {% elif q.type == 'text' %}
                                    <input type="text" class="form-control answer-input" name="answer-{{q.id}}" autocomplete="off" style="font-size:1.25rem; height:3rem;">
                                {% endif %}
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <button type="button" class="btn btn-secondary prev-btn">Previous</button>
                                <button type="button" class="btn btn-warning mark-btn">Mark for Review</button>
                                <button type="button" class="btn btn-success next-btn">Next</button>
                                <button type="button" class="btn btn-primary submit-btn">Submit</button>
                            </div>
                        </div>
                        <div class="d-flex flex-column align-items-center justify-content-center ps-4" style="min-width: 120px;">
                            <div class="btn-group-vertical" role="group" aria-label="Question Navigation">
                                {% for n in range(questions|length) %}
                                <button type="button" class="nav-btn mb-2 rounded-circle border border-2" data-nav="{{n}}" style="width:48px; height:48px; font-weight:bold; font-size:1.2rem; background-color:#e0e0e0; color:#333; transition:background 0.2s;">{{n+1}}</button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </form>
    </div>
    <div id="result-area" class="hidden w-100" style="max-width: 900px;">
        <div class="card">
            <div class="card-body">
                <h2 class="text-center">Quiz Complete!</h2>
                <div id="score-summary" class="mb-4 text-center"></div>
                <div class="table-responsive">
                    <table class="table table-bordered align-middle text-center">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Question</th>
                                <th>Your Answer</th>
                                <th>Result</th>
                                <th>Correct Answer</th>
                                <th>Time (s)</th>
                            </tr>
                        </thead>
                        <tbody id="result-table-body"></tbody>
                    </table>
                </div>
                <div class="text-center">
                    <button class="btn btn-primary" onclick="window.location.reload()">Try Again</button>
                </div>
            </div>
        </div>
    </div>
</div>
document.querySelectorAll('.next-btn').forEach((btn, idx) => {
<script>

const questions = {{ questions|tojson }};
let current = 0;
let times = Array(questions.length).fill(0);
let timers = Array(questions.length).fill(null);
let userAnswers = Array(questions.length).fill(null);
let results = Array(questions.length).fill(false);
let markedForReview = Array(questions.length).fill(false);

function updateStatusHeader() {
    let answered = userAnswers.filter(ans => ans !== null && ans !== '' && !(typeof ans === 'object' && Object.values(ans).every(v => v === ''))).length;
    let total = questions.length;
    let unattempted = total - answered;
    let toreview = markedForReview.filter(Boolean).length;
    document.getElementById('unattempted-count').textContent = unattempted;
    document.getElementById('answered-count').textContent = answered;
    document.getElementById('toreview-count').textContent = toreview;
    document.getElementById('total-count').textContent = total;
}

function startTimer(idx, qid) {
    if (timers[idx]) return;
    timers[idx] = setInterval(() => {
        times[idx]++;
        document.getElementById('timer-' + qid).textContent = `Time: ${times[idx]}s`;
    }, 1000);
}
function stopTimer(idx) {
    if (timers[idx]) { clearInterval(timers[idx]); timers[idx] = null; }
}
function showQuestion(idx) {
    document.querySelectorAll('.question-card').forEach((el, i) => {
        el.style.display = (i === idx) ? '' : 'none';
        // Highlight card if marked for review
        if (markedForReview[i]) {
            el.classList.add('border-warning');
        } else {
            el.classList.remove('border-warning');
        }
    });
    document.querySelectorAll('.nav-btn').forEach((btn, i) => {
        btn.classList.remove('active');
        btn.style.backgroundColor = '#e0e0e0';
        btn.style.color = '#333';
        btn.style.borderColor = '#bdbdbd';
        // Marked for review: yellow
        if (markedForReview[i]) {
            btn.style.backgroundColor = '#ffe066';
            btn.style.color = '#333';
            btn.style.borderColor = '#ffd700';
        // Answered: blue
        } else if (userAnswers[i] !== null && userAnswers[i] !== '' && !(typeof userAnswers[i] === 'object' && Object.values(userAnswers[i]).every(v => v === ''))) {
            btn.style.backgroundColor = '#1976d2';
            btn.style.color = '#fff';
            btn.style.borderColor = '#1976d2';
        // Unanswered: grey
        } else {
            btn.style.backgroundColor = '#e0e0e0';
            btn.style.color = '#333';
            btn.style.borderColor = '#bdbdbd';
        }
        // Current: add a dark border
        if (i === idx) {
            btn.classList.add('active');
            btn.style.borderColor = '#212529';
        }
    });
    startTimer(idx, questions[idx].id);
    updateStatusHeader();
}
// Mark for Review button logic
document.querySelectorAll('.mark-btn').forEach((btn, idx) => {
    btn.addEventListener('click', function() {
        markedForReview[current] = !markedForReview[current];
        showQuestion(current);
    });
});
function getUserAnswer(idx) {
    const q = questions[idx];
    if (q.type === 'single') {
        return document.querySelector(`[name='answer-${q.id}']`).value;
    } else if (q.type === 'dual') {
        return {
            quotient: document.querySelector(`[name='answer-${q.id}-quotient']`).value,
            remainder: document.querySelector(`[name='answer-${q.id}-remainder']`).value
        };
    } else if (q.type === 'text') {
        return document.querySelector(`[name='answer-${q.id}']`).value.trim();
    }
    return null;
}
function checkAnswer(idx, userAns) {
    const q = questions[idx];
    let correct = false;
    if (q.type === 'single') {
        correct = Math.abs(Number(userAns) - Number(q.correct_answer)) < 0.01;
    } else if (q.type === 'dual') {
        correct = (Number(userAns.quotient) === q.correct_answer.quotient && Number(userAns.remainder) === q.correct_answer.remainder);
    } else if (q.type === 'text') {
        if (q.question_text.includes('prime factors')) {
            let ans = q.correct_answer.split(',').map(x => x.trim()).filter(x=>x);
            let user = userAns.split(',').map(x => x.trim()).filter(x=>x);
            correct = (ans.length === user.length && ans.every((v,i)=>v==user[i]));
        } else if (q.question_text.includes('fraction')) {
            correct = (userAns.replace(/\s/g,'') === q.correct_answer.replace(/\s/g,''));
        }
    }
    return correct;
}

function submitQuiz() {
    // Save current answer
    userAnswers[current] = getUserAnswer(current);
    // Evaluate all answers
    let score = 0;
    for (let i = 0; i < questions.length; i++) {
        results[i] = checkAnswer(i, userAnswers[i]);
        if (results[i]) score++;
    }
    document.getElementById('quiz-area').classList.add('hidden');
    document.getElementById('result-area').classList.remove('hidden');
    let totalTime = times.reduce((a,b)=>a+b,0);
    document.getElementById('score-summary').innerHTML = `Score: <b>${score} / ${questions.length}</b><br>Total Time: <b>${totalTime}s</b>`;
    // Fill result table
    let tbody = document.getElementById('result-table-body');
    tbody.innerHTML = '';
    for (let i = 0; i < questions.length; i++) {
        let q = questions[i];
        let userAns = userAnswers[i];
        let correctAns = q.correct_answer;
        let userAnsStr = '';
        let correctAnsStr = '';
        if (q.type === 'single') {
            userAnsStr = userAns;
            correctAnsStr = correctAns;
        } else if (q.type === 'dual') {
            userAnsStr = `Q: ${userAns.quotient}, R: ${userAns.remainder}`;
            correctAnsStr = `Q: ${correctAns.quotient}, R: ${correctAns.remainder}`;
        } else if (q.type === 'text') {
            userAnsStr = userAns;
            correctAnsStr = correctAns;
        }
        tbody.innerHTML += `<tr>
            <td>${i+1}</td>
            <td>${q.question_text}</td>
            <td>${userAnsStr}</td>
            <td>${results[i] ? '<span class=\"text-success\">Correct</span>' : '<span class=\"text-danger\">Incorrect</span>'}</td>
            <td>${results[i] ? '' : correctAnsStr}</td>
            <td>${times[i]}</td>
        </tr>`;
    }
}

document.querySelectorAll('.next-btn').forEach((btn, idx) => {
    btn.addEventListener('click', function() {
        stopTimer(current);
        userAnswers[current] = getUserAnswer(current);
        updateStatusHeader();
        if (current < questions.length - 1) {
            current++;
            showQuestion(current);
        }
    });
});
document.querySelectorAll('.prev-btn').forEach((btn, idx) => {
    btn.addEventListener('click', function() {
        stopTimer(current);
        userAnswers[current] = getUserAnswer(current);
        updateStatusHeader();
        if (current > 0) {
            current--;
            showQuestion(current);
        }
    });
});
document.querySelectorAll('.nav-btn').forEach((btn) => {
    btn.addEventListener('click', function() {
        stopTimer(current);
        userAnswers[current] = getUserAnswer(current);
        updateStatusHeader();
        const navIdx = parseInt(btn.getAttribute('data-nav'), 10);
        if (!isNaN(navIdx) && navIdx >= 0 && navIdx < questions.length) {
            current = navIdx;
            showQuestion(current);
        }
    });
});
document.querySelectorAll('.submit-btn').forEach((btn) => {
    btn.addEventListener('click', function() {
        stopTimer(current);
        userAnswers[current] = getUserAnswer(current);
        updateStatusHeader();
        submitQuiz();
    });
});
// Start first timer and update header
showQuestion(0);
updateStatusHeader();
</script>
</body>
</html>

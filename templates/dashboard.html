<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathMaster Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">MathMaster</a>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-5 align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold text-dark">Welcome back!</h1>
                <p class="lead text-muted">Ready to improve your math skills today?</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="/quiz" class="btn btn-success btn-lg px-5 py-3 shadow hover-zoom">
                    <span class="fs-4">üìù Start New Quiz</span>
                </a>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-4">
                <div class="card shadow-sm border-start border-4 border-primary">
                    <div class="card-body">
                        <h6 class="text-muted">Total Quizzes</h6>
                        <h2 class="fw-bold" id="metric-count">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm border-start border-4 border-success">
                    <div class="card-body">
                        <h6 class="text-muted">Average Score</h6>
                        <h2 class="fw-bold" id="metric-avg">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm border-start border-4 border-warning">
                    <div class="card-body">
                        <h6 class="text-muted">Last Session</h6>
                        <h2 class="fw-bold" id="metric-last">-</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-8">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white fw-bold">Performance Trend</div>
                    <div class="card-body">
                        <canvas id="dashboardChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white fw-bold">Skill Profile</div>
                    <div class="card-body">
                        <canvas id="skillRadar"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadDashboard() {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                const keys = Object.keys(data);

                if (keys.length === 0) {
                    document.getElementById('metric-count').textContent = "0";
                    return; 
                }

                // SORTING (Oldest -> Newest)
                keys.sort((a, b) => {
                    const parse = d => { const p = d.split('-'); return new Date(`20${p[2]}`, p[1]-1, p[0], p[3], p[4]); };
                    return parse(a) - parse(b);
                });

                // --- 1. METRICS & TREND DATA ---
                const scores = keys.map(k => data[k].summary.percentage);
                const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
                
                document.getElementById('metric-count').textContent = keys.length;
                document.getElementById('metric-avg').textContent = Math.round(avg) + "%";
                document.getElementById('metric-last').textContent = data[keys[keys.length-1]].summary.percentage + "%";

                // --- 2. TREND CHART ---
                new Chart(document.getElementById('dashboardChart'), {
                    type: 'line',
                    data: {
                        labels: keys,
                        datasets: [{
                            label: 'Score (%)',
                            data: scores,
                            borderColor: '#1976d2',
                            backgroundColor: 'rgba(25, 118, 210, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });

                // --- 3. SKILL RADAR LOGIC ---
                const skillStats = {}; 
                // Structure: { 'Algebra': { total: 0, correct: 0 }, ... }

                Object.values(data).forEach(session => {
                    session.details.forEach(q => {
                        const cat = q.category || "General";
                        if (!skillStats[cat]) skillStats[cat] = { total: 0, correct: 0 };
                        
                        skillStats[cat].total++;
                        if (q.is_correct) skillStats[cat].correct++;
                    });
                });

                const labels = Object.keys(skillStats);
                const dataPoints = labels.map(cat => {
                    const s = skillStats[cat];
                    return s.total === 0 ? 0 : Math.round((s.correct / s.total) * 100);
                });

                new Chart(document.getElementById('skillRadar'), {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Proficiency (%)',
                            data: dataPoints,
                            fill: true,
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgb(255, 99, 132)',
                            pointBackgroundColor: 'rgb(255, 99, 132)',
                        }]
                    },
                    options: {
                        elements: { line: { tension: 0.2 } },
                        scales: {
                            r: {
                                angleLines: { display: true },
                                suggestedMin: 0,
                                suggestedMax: 100
                            }
                        }
                    }
                });

            } catch (e) {
                console.error("Dashboard error:", e);
            }
        }
        loadDashboard();
    </script>
</body>
</html>